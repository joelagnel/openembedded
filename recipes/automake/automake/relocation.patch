From 4982e20184118a3c7f14aa71dc32ed1ff6864d05 Mon Sep 17 00:00:00 2001
From: Chris Larson <chris_larson@mentor.com>
Date: Tue, 19 Oct 2010 11:16:45 -0700
Subject: [PATCH] aclocal, automake: Handle relocation

We locate our files relative to the location of the installed aclocal and
automake scripts.  Currently, the relative path from bindir to datadir is
hardcoded as ../share.

Signed-off-by: Chris Larson <chris_larson@mentor.com>
---
 aclocal.in  |   24 +++++++++++++++++++++---
 automake.in |   13 ++++++++++++-
 2 files changed, 33 insertions(+), 4 deletions(-)

diff --git a/aclocal.in b/aclocal.in
index a5cee39..07f7689 100644
--- a/aclocal.in
+++ b/aclocal.in
@@ -28,7 +28,18 @@ eval 'case $# in 0) exec @PERL@ -S "$0";; *) exec @PERL@ -S "$0" "$@";; esac'

 BEGIN
 {
-  my $perllibdir = $ENV{'perllibdir'} || '@datadir@/@PACKAGE@-@APIVERSION@';
+  use File::Basename;
+  use File::Spec::Functions "catfile";
+  use Cwd "abs_path";
+
+  my $bindir = dirname(abs_path($0));
+  my $prefix = dirname($bindir);
+  my $datadir = catfile($prefix, "share");
+  if (! -d $datadir) {
+    $datadir = "@datadir@";
+  }
+
+  my $perllibdir = $ENV{'perllibdir'} || $datadir . '/@PACKAGE@-@APIVERSION@';
   unshift @INC, (split '@PATH_SEPARATOR@', $perllibdir);
 }

@@ -43,9 +54,16 @@ use Automake::XFile;
 use Automake::FileUtils;
 use File::Basename;
 use File::stat;
+use File::Spec::Functions "catfile";
 use Cwd;

 # Some globals.
+my $bindir = dirname(abs_path($0));
+my $prefix = dirname($bindir);
+my $datadir = catfile($prefix, "share");
+if (! -d $datadir) {
+  $datadir = "@datadir@"
+}

 # We do not operate in threaded mode.
 $perl_threads = 0;
@@ -57,8 +75,8 @@ $perl_threads = 0;
 # @system_includes can be augmented with the `dirlist' file.  Also
 # --acdir will reset both @automake_includes and @system_includes.
 my @user_includes = ();
-my @automake_includes = ("@datadir@/aclocal-$APIVERSION");
-my @system_includes = ('@datadir@/aclocal');
+my @automake_includes = ("$datadir/aclocal-$APIVERSION");
+my @system_includes = ("$datadir/aclocal");

 # Whether we should copy M4 file in $user_includes[0].
 my $install = 0;
diff --git a/automake.in b/automake.in
index e934c5f..4c6f91f 100755
--- a/automake.in
+++ b/automake.in
@@ -31,7 +31,18 @@ package Language;

 BEGIN
 {
-  my $perllibdir = $ENV{'perllibdir'} || '@datadir@/@PACKAGE@-@APIVERSION@';
+  use File::Basename;
+  use File::Spec::Functions "catfile";
+  use Cwd "abs_path";
+
+  my $bindir = dirname(abs_path($0));
+  my $prefix = dirname($bindir);
+  my $datadir = catfile($prefix, "share");
+  if (! -d $datadir) {
+    $datadir = "@datadir@";
+  }
+
+  my $perllibdir = $ENV{'perllibdir'} || $datadir . '/@PACKAGE@-@APIVERSION@';
   unshift @INC, (split '@PATH_SEPARATOR@', $perllibdir);

   # Override SHELL.  This is required on DJGPP so that system() uses
--
1.7.2.3
